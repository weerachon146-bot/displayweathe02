<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard - Chart Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e1ffeb 100%); min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-10 text-center md:text-left">
            <h1 class="text-3xl font-bold text-gray-800">üìä ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h1>
            <p id="statusMessage" class="text-sm text-gray-500 mt-2"></p>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-md mb-10 border border-green-100">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                
                <div>
                    <label class="block text-xs font-bold text-green-700 mb-2 uppercase">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <select id="dateSelector" class="w-full bg-gray-50 border border-green-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-green-400"></select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-green-700 mb-2 uppercase">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</label>
                    <select id="hourSelector" class="w-full bg-gray-50 border border-green-200 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-green-400"></select>
                </div>

                <div class="text-center md:text-right">
                    <button onclick="displayData()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-10 rounded-xl shadow-lg transition-all active:scale-95">
                        ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="glass-card p-6 rounded-2xl shadow-sm border-t-4 border-orange-400 text-center">
                    <p class="text-gray-500 text-sm">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)</p>
                    <h2 id="valTemp" class="text-4xl font-bold text-orange-600">--</h2>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-sm border-t-4 border-blue-400 text-center">
                    <p class="text-gray-500 text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</p>
                    <h2 id="valHum" class="text-4xl font-bold text-blue-600">--</h2>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-sm border-t-4 border-purple-400 text-center">
                    <p class="text-gray-500 text-sm">VPD</p>
                    <h2 id="valVPD" class="text-4xl font-bold text-purple-600">--</h2>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-sm border-t-4 border-teal-400 text-center">
                    <p class="text-gray-500 text-sm">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ù‡∏ô (mm)</p>
                    <h2 id="valRain" class="text-4xl font-bold text-teal-600">--</h2>
                </div>
            </div>
            <div class="glass-card p-6 rounded-3xl shadow-md flex flex-col items-center justify-center">
                <h3 class="text-lg font-bold text-gray-700 mb-4">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ</h3>
                <div class="w-full max-w-[300px]">
                    <canvas id="weatherChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let weatherData = [];
        let myChart = null;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å LocalStorage (‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤)
        window.onload = function() {
            const savedData = localStorage.getItem('sharedWeatherData');
            if (savedData) {
                processHTML(savedData);
                document.getElementById('statusMessage').innerText = "";
            }
        };

        function processHTML(htmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const rows = doc.querySelectorAll('tr');
            weatherData = [];
            const dateSet = new Set();
            const timeSet = new Set();

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const dateTimeStr = cells[0].innerText.trim();
                    if (/\d{4}-\d{2}-\d{2}/.test(dateTimeStr)) {
                        const parts = dateTimeStr.split(' ');
                        weatherData.push({
                            date: parts[0], time: parts[1],
                            temp: parseFloat(cells[1].innerText) || 0,
                            vpd: parseFloat(cells[2].innerText) || 0,
                            hum: parseFloat(cells[3].innerText) || 0,
                            rain: parseFloat(cells[4].innerText) || 0
                        });
                        dateSet.add(parts[0]); timeSet.add(parts[1]);
                    }
                }
            });
            updateDropdowns(Array.from(dateSet).sort().reverse(), Array.from(timeSet).sort());
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if(weatherData.length > 0) displayData();
        }

        function updateDropdowns(dates, times) {
            document.getElementById('dateSelector').innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
            document.getElementById('hourSelector').innerHTML = times.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function displayData() {
            const selDate = document.getElementById('dateSelector').value;
            const selTime = document.getElementById('hourSelector').value;
            const match = weatherData.find(d => d.date === selDate && d.time === selTime);
            if (match) {
                document.getElementById('valTemp').innerText = match.temp + " ¬∞C";
                document.getElementById('valHum').innerText = match.hum + " %";
                document.getElementById('valVPD').innerText = match.vpd;
                document.getElementById('valRain').innerText = match.rain + " mm";
                updateChart(match);
            }
        }

        function updateChart(data) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            const chartData = {
                labels: ['‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô', 'VPD', '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ù‡∏ô'],
                datasets: [{ 
                    data: [data.temp, data.hum, data.vpd, data.rain], 
                    backgroundColor: ['#f97316', '#3b82f6', '#a855f7', '#14b8a6'] 
                }]
            };
            if (myChart) { 
                myChart.data = chartData; 
                myChart.update(); 
            } else { 
                myChart = new Chart(ctx, { type: 'doughnut', data: chartData }); 
            }
        }
    </script>
</body>
</html>